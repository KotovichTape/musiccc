{% extends "rental/base.html" %}

{% block title %}–ö–∞–±–∏–Ω–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞{% endblock %}

{% block content %}
<style>
  .modal-bg {
    display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;
  }
  .modal-bg.active { display: flex; }
  .modal-content {
    background: #fff; padding: 2em 2em 1em 2em; border-radius: 12px; max-width: 400px; margin: auto;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }
  .modal-content h4 { margin-top: 0; }
  .modal-content label { font-weight: 500; margin-bottom: 0.2em; display: block; }
  .modal-content input, .modal-content textarea { width: 100%; margin-bottom: 1em; }
  .modal-content button { margin-right: 0.5em; }
  .btn-warning { font-weight: 600; }
  .success-toast {
    display: none; position: fixed; top: 30px; right: 30px; background: #4caf50; color: #fff; padding: 1em 2em; border-radius: 8px; z-index: 2000; font-size: 1.1em;
  }
  .success-toast.active { display: block; }
  table.table th, table.table td { vertical-align: middle; }
</style>

<div class="success-toast" id="successToast">–†–µ–º–æ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</div>

<h2>–ö–∞–±–∏–Ω–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</h2>
<p>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏ —Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.</p>
<a href="{% url 'logout' %}" class="btn btn-danger">–í—ã–π—Ç–∏</a>

<h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h3>
{% if waiting_equipment %}
<table class="table table-striped table-bordered">
    <tr>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    {% for check in waiting_equipment %}
    <tr id="check-{{ check.id }}">
        <td><b>{{ check.equipment.name }}</b></td>
        <td class="status">üü° {{ check.status }}</td>
        <td>{{ check.notes|default:"-" }}</td>
        <td>
            <button class="btn btn-warning repair-btn" data-id="{{ check.id }}" data-eq="{{ check.equipment.name }}">–†–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>‚ùå –ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>
{% endif %}

<div class="modal-bg" id="repairModal">
  <div class="modal-content">
    <h4>–†–µ–º–æ–Ω—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: <span id="modal-eq-name"></span></h4>
    <form id="repairForm">
      <input type="hidden" name="check_id" id="modal-check-id">
      <div class="mb-2">
        <label for="modal-description">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞:</label>
        <textarea name="description" id="modal-description" class="form-control" required placeholder="–ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ, —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ..."></textarea>
      </div>
      <div class="mb-2">
        <label for="modal-cost">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞ (‚ÇΩ):</label>
        <input type="number" name="cost" id="modal-cost" class="form-control" min="0" required placeholder="0">
      </div>
      <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" class="btn btn-secondary" id="closeModalBtn">–û—Ç–º–µ–Ω–∞</button>
    </form>
  </div>
</div>

<h3>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫</h3>
{% if history_checks %}
<table class="table table-striped table-bordered">
    <tr>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
    </tr>
    {% for check in history_checks %}
    <tr>
        <td>{{ check.equipment.name }}</td>
        <td>
            {% if check.status == "checked_ok" %}
                üü¢ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, –∏—Å–ø—Ä–∞–≤–Ω–æ
            {% elif check.status == "needs_repair" or check.status == "repaired" %}
                üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–º–æ–Ω—Ç
            {% else %}
                {{ check.status }}
            {% endif %}
        </td>
        <td>{{ check.updated_at|date:"d.m.Y H:i"|default:"-" }}</td>
        <td>{{ check.notes|default:"-" }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>üì≠ –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø—É—Å—Ç–∞.</p>
{% endif %}

<h3>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã</h3>
{% if completed_repairs %}
<table class="table table-striped table-bordered">
    <tr>
        <th>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
        <th>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
    </tr>
    {% for repair in completed_repairs %}
    <tr>
        <td>{{ repair.equipment.name }}</td>
        <td>{{ repair.completed_at|date:"d.m.Y H:i"|default:"-" }}</td>
        <td>{{ repair.repair_cost|default:"-" }} ‚ÇΩ</td>
        <td>{{ repair.description|default:"-" }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>üì≠ –ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤.</p>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.repair-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('repairModal').classList.add('active');
                document.getElementById('modal-check-id').value = this.dataset.id;
                document.getElementById('modal-eq-name').textContent = this.dataset.eq;
                document.getElementById('modal-description').value = '';
                document.getElementById('modal-cost').value = '';
            });
        });
        document.getElementById('closeModalBtn').onclick = function() {
            document.getElementById('repairModal').classList.remove('active');
        };
        document.getElementById('repairForm').onsubmit = function(e) {
            e.preventDefault();
            const checkId = document.getElementById('modal-check-id').value;
            const description = document.getElementById('modal-description').value;
            const cost = document.getElementById('modal-cost').value;
            fetch(`/perform-equipment-repair/${checkId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({description, cost})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('–†–µ–º–æ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                    document.getElementById('repairModal').classList.remove('active');
                    setTimeout(() => window.location.reload(), 800);
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞!');
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞.');
            });
        };
        function showToast(msg) {
            const toast = document.getElementById('successToast');
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 1500);
        }
    });
</script>
{% endblock %}
